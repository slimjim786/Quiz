<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Team Quiz (Realtime)</title>
<style>
  :root{--bg:#0f1226;--panel:#171b34;--text:#e9ecff;--muted:#9aa3c7;--primary:#6e8bff;--primary-2:#8aa2ff;--accent:#30e0a1;--danger:#ff6b6b;--focus:#ffd166;--radius:16px}
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:radial-gradient(1200px 800px at 20% 0%,#131739 0%,#0f1226 60%,#0c0f21 100%);color:var(--text)}
  header{padding:28px 18px 8px;text-align:center} header h1{margin:0;font-size:clamp(1.6rem,2.2vw+1rem,2.4rem)} header p{margin:.25rem 0 0;color:var(--muted)}
  main{max-width:880px;margin:0 auto;padding:18px}
  .card{background:linear-gradient(180deg,#1a1f3f 0%,var(--panel) 50%);border:1px solid #ffffff10;border-radius:var(--radius);box-shadow:0 10px 30px #00000059;padding:clamp(14px,1.2vw+8px,22px)}
  .row{display:flex;gap:8px;align-items:center}.spacer{flex:1}.muted{color:var(--muted)}.hint{color:var(--muted)}
  button{border:0;background:var(--primary);color:#0a0d1f;font-weight:700;border-radius:12px;padding:12px 14px;cursor:pointer;transition:transform .02s,filter .2s}
  button:hover{filter:brightness(1.08)}button:active{transform:translateY(1px)}button[disabled]{opacity:.45;cursor:not-allowed}
  .btn-outline{background:transparent;color:var(--text);border:1px solid #ffffff2e}.btn-danger{background:var(--danger);color:#190b0b}.btn-ghost{background:transparent;color:var(--muted);border:1px dashed #ffffff26}
  input[type=text]{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #ffffff26;background:#0f1330;color:var(--text)} input[type=text]:focus{box-shadow:0 0 0 3px var(--focus);border-color:transparent}
  .team-list{display:grid;gap:10px;margin-top:12px}.team-item{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 12px;border:1px solid #ffffff1f;border-radius:12px;background:#121636}
  .team-name{font-weight:700}.badge{padding:4px 8px;border-radius:100px;background:#0f1330;color:var(--muted);border:1px solid #ffffff20;font-size:.8rem}
  .progress-wrap{display:flex;align-items:center;gap:10px;margin:8px 0 16px}.progress{height:10px;border-radius:999px;background:#0c1030;border:1px solid #ffffff1f;width:100%;overflow:hidden}.bar{height:100%;background:linear-gradient(90deg,var(--primary),var(--primary-2));width:0%}
  .q-text{font-size:clamp(1.1rem,1.2vw+1rem,1.6rem);font-weight:700}.options{display:grid;gap:10px;margin:14px 0}
  .opt{width:100%;text-align:left;background:#121636;color:var(--text);border:1px solid #ffffff24;border-radius:12px;padding:12px;cursor:pointer}
  .opt.correct{outline:3px solid var(--accent)}.opt.wrong{outline:3px solid var(--danger)}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:.85rem;padding:2px 8px;border-radius:6px;background:#0f1330;border:1px solid #ffffff26;color:var(--muted)}
</style>
</head>
<body>
<header>
  <h1>Team Quiz</h1>
  <p class="muted">Register up to 5 teams, then let each team play. Scores stream to the private scoreboard page.</p>
</header>

<main>
  <section class="card" id="view">
    <!-- LOBBY -->
    <div id="lobby-view" role="region" aria-labelledby="lobby-title">
      <h2 id="lobby-title">Team Lobby</h2>
      <p class="hint">Add a team name (max 20 characters). Names must be unique.</p>
      <form id="team-form" class="row" autocomplete="off">
        <input type="text" id="team-name" placeholder="e.g., Lightning Bolts" maxlength="20" required />
        <button id="add-team" type="submit">Add Team</button>
      </form>
      <div class="team-list" id="team-list" aria-live="polite"></div>
      <p class="hint" id="team-limit-hint" style="display:none">Limit reached (5 teams). Remove one to add another.</p>
      <div class="row" style="margin-top:10px">
        <button class="btn-ghost" id="clear-all">Clear all data (this device)</button>
        <div class="spacer"></div>
        <span class="muted">Keyboard: <span class="kbd">1–6</span> answer • <span class="kbd">Enter</span> next</span>
      </div>
    </div>

    <!-- QUIZ -->
    <div id="quiz-view" style="display:none" role="region" aria-labelledby="quiz-title">
      <div class="row" style="margin-bottom:8px">
        <button class="btn-outline" id="back-to-lobby">&larr; Lobby</button>
        <div class="spacer"></div>
        <span class="badge" id="playing-team">Team: —</span>
      </div>
      <h2 id="quiz-title">Quiz</h2>
      <div class="progress-wrap">
        <div class="progress" aria-label="Progress"><div class="bar" id="bar"></div></div>
        <span id="progress-label" class="muted">0 / 0</span>
      </div>
      <div class="q-text" id="q-text">Question here</div>
      <div class="options" id="options"></div>
      <div class="row">
        <button id="next-btn" disabled>Next</button>
        <div class="spacer"></div>
        <span class="muted" id="feedback"></span>
      </div>
    </div>

    <!-- RESULTS (no score shown to team) -->
    <div id="results-view" style="display:none" role="region" aria-labelledby="results-title">
      <h2 id="results-title">Run saved</h2>
      <p class="muted">Thanks! Your attempt has been recorded.</p>
      <div class="row" style="margin-top:12px">
        <button id="play-again">Play again</button>
        <button class="btn-outline" id="back-home">&larr; Lobby</button>
      </div>
    </div>
  </section>
</main>

<!-- ✅ Everything (including Firebase) is inside one module for clarity -->
<script type="module">
  /* ---------- 1) Firebase imports + init ---------- */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getFirestore, collection, addDoc, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  // 🔁 REPLACE with your Firebase config (copy from Firebase Console)
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  /* ---------- 2) Quiz data (edit your questions) ---------- */
  const QUESTIONS = [
    { text: "Which planet is known as the Red Planet?", options: ["Earth","Mars","Jupiter","Venus"], answerIndex: 1 },
    { text: "What is 9 × 6?", options: ["42","52","54","56"], answerIndex: 2 },
    { text: "Who wrote 'Romeo and Juliet'?", options: ["Charles Dickens","Jane Austen","William Shakespeare","Mark Twain"], answerIndex: 2 },
    { text: "The chemical symbol for water is…", options: ["WO","H2O","HO2","OH2"], answerIndex: 1 }
  ];

  /* ---------- 3) Shared storage (local teams list) ---------- */
  const STORE_KEYS = { teams: "quiz_teams_v1" };
  const loadJSON = (k,f)=>{ try{ return JSON.parse(localStorage.getItem(k)) ?? f } catch { return f } };
  const saveJSON = (k,v)=> localStorage.setItem(k, JSON.stringify(v));
  const MAX_TEAMS = 5;
  let teams = loadJSON(STORE_KEYS.teams, []);

  /* ---------- 4) DOM helpers ---------- */
  const $ = (id)=>document.getElementById(id);
  const escapeHtml = s => String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  const shuffle = a => { for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } };

  /* ---------- 5) Lobby UI ---------- */
  function renderLobby(){
    const list = $("team-list"); list.innerHTML = "";
    teams.forEach(team=>{
      const row = document.createElement("div");
      row.className = "team-item";
      row.innerHTML = `
        <span class="team-name">${escapeHtml(team.name)}</span>
        <span class="spacer"></span>
        <button class="btn-outline" data-start>Start quiz</button>
        <button class="btn-danger" data-remove>Remove</button>
      `;
      row.querySelector("[data-start]").addEventListener("click", ()=>startQuiz(team.id));
      row.querySelector("[data-remove]").addEventListener("click", ()=>{
        if(confirm(`Remove team "${team.name}"?`)){
          teams = teams.filter(t=>t.id!==team.id);
          saveJSON(STORE_KEYS.teams, teams);
          renderLobby();
        }
      });
      list.appendChild(row);
    });
    const atLimit = teams.length >= MAX_TEAMS;
    $("team-limit-hint").style.display = atLimit ? "block" : "none";
    $("add-team").disabled = atLimit;
  }

  $("team-form").addEventListener("submit", (e)=>{
    e.preventDefault();
    const name = $("team-name").value.trim();
    if(!name) return;
    if(name.length>20) return alert("Max 20 characters.");
    if(teams.some(t=>t.name.toLowerCase()===name.toLowerCase())) return alert("That name is taken.");
    if(teams.length>=MAX_TEAMS) return alert("Maximum 5 teams.");
    teams.push({ id: Math.random().toString(36).slice(2,10), name });
    saveJSON(STORE_KEYS.teams, teams);
    $("team-name").value="";
    renderLobby();
  });

  $("clear-all").addEventListener("click", ()=>{
    if(confirm("Clear TEAMS on this device? (Scores live in Firebase.)")){
      localStorage.removeItem(STORE_KEYS.teams);
      teams = [];
      renderLobby();
    }
  });

  /* ---------- 6) Quiz engine + Firestore live updates ---------- */
  let currentTeam = null, order=[], qIndex=0, score=0, answered=null, runDocRef=null;

  function startQuiz(teamId){
    currentTeam = teams.find(t=>t.id===teamId);
    if(!currentTeam) return alert("Team not found.");
    order = [...Array(QUESTIONS.length).keys()]; shuffle(order);
    qIndex=0; score=0; answered=null;

    // Create a document for this attempt in Firestore
    (async ()=>{
      try{
        runDocRef = await addDoc(collection(db,"attempts"), {
          teamId: currentTeam.id,
          teamName: currentTeam.name,
          status: "in_progress",
          score: 0,
          total: QUESTIONS.length,
          currentIndex: 0,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
      }catch(e){ console.warn("Firestore start error", e); }
    })();

    $("lobby-view").style.display="none";
    $("results-view").style.display="none";
    $("quiz-view").style.display="block";
    $("playing-team").textContent = `Team: ${currentTeam.name}`;
    renderQuestion();
  }

  function renderQuestion(){
    const total = order.length;
    const q = QUESTIONS[order[qIndex]];
    $("q-text").textContent = q.text;
    $("progress-label").textContent = `${qIndex+1} / ${total}`;
    $("bar").style.width = `${(qIndex/total)*100}%`;
    $("feedback").textContent = "";
    $("next-btn").disabled = true;

    const wrap = $("options"); wrap.innerHTML="";
    const opts = q.options.map((t,i)=>({t,i})); shuffle(opts);
    const corr = q.answerIndex, corrText = q.options[corr];

    opts.forEach((o,i)=>{
      const btn = document.createElement("button");
      btn.className="opt";
      btn.innerHTML = `<span class="kbd" aria-hidden="true">${i+1}</span> ${escapeHtml(o.t)}`;
      btn.addEventListener("click", ()=>{
        if(answered!==null) return;
        answered = (o.i===corr);
        if(answered){ score++; $("feedback").textContent="✔"; } else { $("feedback").textContent="✖"; }
        // mark + lock
        [...wrap.querySelectorAll(".opt")].forEach(b=>b.disabled=true);
        const buttons=[...wrap.querySelectorAll(".opt")];
        const correctBtn = buttons.find(b=>b.textContent.includes(corrText));
        correctBtn && correctBtn.classList.add("correct");
        if(!answered) btn.classList.add("wrong");
        $("next-btn").disabled = false;

        // 🔴 Update Firestore progress
        (async ()=>{
          try{
            if(!runDocRef) return;
            await updateDoc(runDocRef, {
              score,
              currentIndex: qIndex + 1,
              updatedAt: serverTimestamp()
            });
          }catch(e){ console.warn("Firestore progress error", e); }
        })();
      });
      wrap.appendChild(btn);
    });

    // Keyboard
    window.onkeydown = (e)=>{
      if(['INPUT','TEXTAREA','BUTTON'].includes(document.activeElement.tagName)) return;
      if(/^[1-6]$/.test(e.key)){
        const n = +e.key;
        const target = wrap.querySelector(`.opt:nth-child(${n})`);
        if(target) target.click();
      } else if(e.key==="Enter"){
        if(!$("next-btn").disabled) $("next-btn").click();
      }
    };
  }

  $("next-btn").addEventListener("click", ()=>{
    if(answered===null) return;
    qIndex++;
    if(qIndex>=order.length) finishQuiz();
    else { answered=null; renderQuestion(); }
  });

  function finishQuiz(){
    $("bar").style.width="100%";
    // ✅ Mark as finished in Firestore
    (async ()=>{
      try{
        if(runDocRef){
          await updateDoc(runDocRef, {
            status: "finished",
            score,
            currentIndex: QUESTIONS.length,
            finishedAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          });
          runDocRef = null;
        }
      }catch(e){ console.warn("Firestore finish error", e); }
    })();

    $("quiz-view").style.display="none";
    $("results-view").style.display="block";
  }

  $("play-again").addEventListener("click", ()=>{ if(currentTeam) startQuiz(currentTeam.id); });
  $("back-home").addEventListener("click", ()=>{ currentTeam=null; $("results-view").style.display="none"; $("lobby-view").style.display="block"; });
  $("back-to-lobby").addEventListener("click", ()=>{ if(confirm("Quit and return to lobby?")){ currentTeam=null; $("quiz-view").style.display="none"; $("lobby-view").style.display="block"; } });

  renderLobby();
</script>
</body>
</html>
